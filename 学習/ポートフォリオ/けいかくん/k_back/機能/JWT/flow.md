# JWT

```py
@router.post("/token")
:
:
user = await staff_crud.get_by_email(db, email=username)
:
:
# MFA有効チェック                                                                                   
if user.is_mfa_enabled:                                                                                        
    # → 一時トークン発行してMFA検証フローへ 
```

## JWTの仕組みを説明してください


1. ユーザー認証: ユーザーがログイン情報（ユーザー名やパスワード）をサーバーに送信します。
2. トークン生成: 認証が成功すると、サーバーはJWTを生成します。このトークンには、ユーザー情報（ペイロード）と有効期限が含まれます。
3. トークン送信: サーバーは生成したJWTをクライアント（ブラウザやアプリ）に返します。
4. トークン保存: クライアントは受け取ったJWTを安全な場所に保存します（通常はHttpOnly CookieやLocalStorage）。
5. トークン送信: クライアントは、以降のリクエストでこのJWTをサーバーに送信します（通常はAuthorizationヘッダーに含めて）。
6. トークン検証: サーバーは受け取ったJWTの署名を検証し、有効期限内であることを確認します。これにより、リクエストが正当なクライアントから来たものであることを保証します。
7. リソースアクセス: 検証が成功した場合、サーバーはクライアントにリソースへのアクセスを許可します。


## トークンの構造（Header.Payload.Signature）
JWTの構成
ヘッダー
{
  "alg": "HS256",
  "typ": "JWT"
}

ペイロード
{
  "sub": "1234567890",
  "name": "John Doe",
  "iat": 1516239022
}

シグネチャー
## トークンの有効期限はどう設定していますか？アクセストークン：15分〜1時間、リフレッシュトークン：7日など
ALGORITHM = "HS256"                    # 署名アルゴリズム
ACCESS_TOKEN_EXPIRE_MINUTES = 30       # アクセストークン：30分
REFRESH_TOKEN_EXPIRE_DAYS = 7          # リフレッシュトークン：7日

## トークンはどこに保存していますか？
HttpOnly Cookie
理由：XSS攻撃によるトークン窃取を防ぐため

## HttpOnly Cookie / localStorage の選択理由
HttpOnly Cookie: XSS攻撃によるトークン窃取を防ぐため

## リフレッシュトークンは実装していますか？はい/いいえ と理由
はい
理由：アクセストークンの有効期限が切れた場合に、新しいアクセストークンを取得するため